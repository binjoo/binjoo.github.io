<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><title>JAVA折腾微信公众平台（Token验证） - 嘀咕</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.7.0/style.min.css"><link rel="stylesheet" href="/css/forever.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><meta name="generator" content="Hexo 7.1.1"></head><body><div class="wrap flex fd-c fai-c my-4 gap-4"><header class="flex fd-r fai-c fjc-sb mt-4 mb-8 gap-8"><div class="logo mb-1"><a class="flex px-2" href="/"><div class="draw"><div class="ghost"><div class="body"><div class="face"><div class="eyes"><span></span><span></span></div><div class="mouth"></div></div><div class="hands"> </div></div><div class="feet"><span></span><span></span><span></span><span></span></div></div></div><span class="name flex fjc-c fai-c">嘀咕</span></a></div><ul class="flex m-0 p-0 ta-c gap-6"><li><a href="/">首页</a></li><li><a href="/says">碎语</a></li><li><a href="/archives">归档</a></li><li><a href="/friends">朋友</a></li><li><a href="/about">关于</a></li></ul></header><main><article><div class="header flex fd-c fai-c"><h1 class="my-0">JAVA折腾微信公众平台（Token验证）</h1><time datetime="2013-03-27T17:38:00.000Z">2013-03-28 01:38</time></div><div class="content mt-6"><p>BAE的JAVA还在内测的时候，抱着好奇的态度发邮件申请了内测权限，当时折腾了一天，然后就没折腾了。现在BAE的JAVA都已经正式开放使用了，我又蛋疼的想写点什么，否则每天仅仅只是工作上的使用，是得不到多大的进步的。</p>
<p>最近微信的公众平台比较火，于是我也想弄个微信来玩玩。<a target="_blank" rel="noopener" href="http://kf.qq.com/info/79069.html">如何注册微信公众号？</a>点击之后就可以看到官方的答案了（额，比较坑爹）。</p>
<p>注册之后，可以选择编辑模式和开发模式，这里要说的是开发模式。</p>
<p>首先要开启开发模式必须要进行Token的一个验证，你给出一个地址，微信发送请求，然后你给出相应，就这么简单。虽然说是简单，但是这是事后才说的，官方只有PHP的DEMO，我用JAVA开发的时候各种蛋疼不会弄，不过好在还是弄出来了。</p>
<h2 id="上传代码"><a href="#上传代码" class="headerlink" title="上传代码"></a>上传代码</h2><p>以下代码是校验Token的关键代码，其中还有一个SHA1加密的类在附件中，这里就不贴出来了。需要注意的是，这里的类我是继承的HttpServlet，也就是说要进行web.xml的配置，这个就不多说了。</p>
<p>无问题后上传到你的空间，我用的是BAE，大家也可以试试。</p>
<div class="code-block mb-6"><div class="header px-4 py-3" data-language="java"><span></span><span></span><span></span></div><div class="body flex fd-r"><div class="line-numbers py-1 mx-3"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div><pre class="language-java m-0 mr-4 py-1" data-language="java"><code class="language-java p-0"><span class="token keyword">package</span> <span class="token namespace">net<span class="token punctuation">.</span>binjoo<span class="token punctuation">.</span>wechat</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServlet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>binjoo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">SHA1</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"serial"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WechatCallbackApi</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 自定义 token</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token constant">TOKEN</span> <span class="token operator">=</span> <span class="token string">"这个地方由你自己定义"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 微信加密签名</span>
        <span class="token class-name">String</span> signature <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"signature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 随机字符串</span>
        <span class="token class-name">String</span> echostr <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"echostr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 时间戳</span>
        <span class="token class-name">String</span> timestamp <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 随机数</span>
        <span class="token class-name">String</span> nonce <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"nonce"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> str <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token constant">TOKEN</span><span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字典序排序</span>
        <span class="token class-name">String</span> bigStr <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> str<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// SHA1加密</span>
        <span class="token class-name">String</span> digest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SHA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDigestOfString</span><span class="token punctuation">(</span>bigStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 确认请求来至微信</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>digest<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre></div></div>

<h2 id="开启消息接口"><a href="#开启消息接口" class="headerlink" title="开启消息接口"></a>开启消息接口</h2><p>进入微信公众平台，选择导航菜单栏中的【高级设置 - 开发模式 - 成为开发者】或者点击<a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/cgi-bin/operadvancedfunc?op=list&t=wxm-developer-api&lang=zh_CN">这里</a>进入，进入后填写网址URL和Token，其中Token可由可以任意填写，用作生成签名，但必须与<code>WechatCallbackApi</code>类中的常量TOKEN一致，否则不能通过校验，成不了开发者。 </p>
<p>一切填写无问题之后，点击提交就可以了。是否通过的结果马上就可以得到响应，希望大家都能够看到【提交成功】的提示。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://download.csdn.net/download/binjoo/8235047">CSDN</a>、<a target="_blank" rel="noopener" href="https://www.lanzous.com/ib6gybi">蓝奏云</a>、<a target="_blank" rel="noopener" href="https://app.box.com/s/i36zpg3w2ne9dl8dgs094adeoferb93w">BOX</a></p>
</div></article><div class="end flex fai-c fjc-c mb-4"><span class="flex fai-c fjc-c my-4 o2">THE-END</span></div><div class="tags my-4"><ul class="flex fjc-c fd-r gap-4"><li><a class="py-1 px-4 flex fd-c fai-c" href="/tags/%E6%8A%98%E8%85%BE/"><span>折腾<sup>14</sup></span></a></li><li><a class="py-1 px-4 flex fd-c fai-c" href="/tags/%E5%BE%AE%E4%BF%A1/"><span>微信<sup>2</sup></span></a></li><li><a class="py-1 px-4 flex fd-c fai-c" href="/tags/Java/"><span>Java<sup>2</sup></span></a></li></ul></div><div class="near flex fjc-sb mb-4"><div class="prev"><a href="/post/48e7f79a46ec1abb1d170ca9bd14d84c/" ref="prev"><div class="text fw-b">PREVIOUS</div><div class="name">吐槽新浪微博的找回密码</div></a></div><div class="next"><a href="/post/9a02b56cbf7e4c3f847bfb78c4d19cbe/" ref="next"><div class="text">NEXT</div><div class="name">我是一只鲜果频道认领日志</div></a></div></div><div class="comments"><div class="comment-items"><h2 class="pl-2">评论列表</h2><div class="not-found flex fai-c fjc-c">「此时无声胜有声」</div></div></div></main><footer class="flex fjc-c"><div class="copyright"><p>© 2007 - 现在 <a href="">嘀咕</a></p></div></footer><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script><script type="text/javascript" src="/js/forever.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery-lazyload@1.9.7/jquery.lazyload.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script></div></body></html>