<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="theme-color" content="#202020"><meta http-equiv="x-ua-compatible" content="ie=edge"><title>禁止黑名单的评论 - 嘀咕</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.7.0/style.min.css"><link rel="stylesheet" href="/css/forever.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><meta name="generator" content="Hexo 7.1.1"></head><body><div class="wrap flex fd-c fai-c my-4 gap-4"><header class="flex fd-r fai-c fjc-sb mt-4 mb-8 gap-8"><div class="logo mb-1"><a class="flex px-2" href="/"><div class="draw"><div class="ghost"><div class="body"><div class="face"><div class="eyes"><span></span><span></span></div><div class="mouth"></div></div><div class="hands"> </div></div><div class="feet"><span></span><span></span><span></span><span></span></div></div></div><span class="name flex fjc-c fai-c">嘀咕</span></a></div><ul class="flex m-0 p-0 ta-c gap-6"><li><a href="/">首页</a></li><li><a href="/says">碎语</a></li><li><a href="/archives">归档</a></li><li><a href="/friends">朋友</a></li><li><a href="/about">关于</a></li></ul></header><main><article><div class="header flex fd-c fai-c"><h1 class="my-0">禁止黑名单的评论</h1><time datetime="2010-08-10T19:19:00.000Z">2010-08-11 03:19</time></div><div class="content mt-6"><p>最近为 SPAM 的事情烦透了，虽然每天的 SPAM 信息不多，但是也很烦人，还特意写了一篇文章<a target="_blank" rel="noopener" href="http://jan.cm/2010/08/fuck-spammer/">《老子受不了你们了》</a>来解解气。</p>
<p>虽然很多 SPAM 都是被丢进了垃圾评论中，但是每天看到垃圾评论中有垃圾心里很不爽。后台有个评论黑名单的功能，但是我觉得没什么作用。比如你把 <a href="mailto:&#120;&#120;&#x6f;&#x6f;&#x40;&#x78;&#x78;&#x6f;&#x6f;&#x2e;&#x63;&#111;&#x6d;">&#120;&#120;&#x6f;&#x6f;&#x40;&#x78;&#x78;&#x6f;&#x6f;&#x2e;&#x63;&#111;&#x6d;</a> 这个邮箱加进了黑名单，WP前台并不能阻止这条评论写进数据库，他只是会把这条评论列为垃圾放在垃圾评论中，个人觉得这个功能有些鸡肋。</p>
<p>前几天想到一个办法，就是当用户提交的评论写到数据库之前，进行一次判断，看看黑名单中是否有这些信息，如果有的话那么就返回，不写入数据库，没有的话就正常的执行。想法我觉得蛮好，但是就是TM不会PHP，郁闷了。昨天在本地用 JavaScript 写了一个，效果倒是实现了，可惜操作起来非常的麻烦，因为黑名单并不能从数据库中读取出来，而是用一个数组保存的，然后再一个个匹配，这样的执行效率很低。</p>
<p>今天又闲着蛋疼，认真的折腾一下，发现用 PHP 实现起来也不是很难，当然这只是相对于我的博客，因为我的博客评论方式是 AJAX 的。虽然不会 PHP ，但是看懂一些代码还是没问题的，其实这个功能的实现也基本不难，就只是写一条 SQL 语句，然后再判断一下就搞定了。</p>
<p>效果如下图，提交后，访客的昵称、EMAIL、网址出现在黑名单中的话，就会出现提示。</p>
<p>废话了那么多，开始正题，我的评论 Ajax 效果是出自<a target="_blank" rel="noopener" href="http://www.xiaorsz.com/jquery-wordpress-ajax-comments/">《使用 jQuery 实现 wordpress 的 Ajax 留言》</a>，修改的文件也是这篇文章中所新增加的<code>comments-ajax.php</code>文件。</p>
<p>整个也就一个步骤，把下列代码加入到文件中，具体什么位置你看着办吧，我是加在了评论不能为空的判断之后。 </p>
<div class="code-block mb-6"><div class="header px-4 py-3" data-language="php"><span></span><span></span><span></span></div><div class="body flex fd-r"><div class="line-numbers py-1 mx-3"><span></span><span></span><span></span><span></span></div><pre class="language-php m-0 mr-4 py-1" data-language="php"><code class="language-php p-0"><span class="token variable">$spam</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT COUNT(*) FROM <span class="token interpolation"><span class="token variable">$wpdb</span><span class="token operator">-></span><span class="token property">options</span></span> WHERE option_name = 'blacklist_keys' AND (option_value like '%"</span><span class="token operator">.</span><span class="token variable">$comment_author</span><span class="token operator">.</span><span class="token string double-quoted-string">"%' or option_value like '%"</span><span class="token operator">.</span><span class="token variable">$comment_author_email</span><span class="token operator">.</span><span class="token string double-quoted-string">"%' or option_value like '%"</span><span class="token operator">.</span><span class="token variable">$comment_author_url</span><span class="token operator">.</span><span class="token string double-quoted-string">"%')"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$wpdb</span><span class="token operator">-></span><span class="token function">get_var</span><span class="token punctuation">(</span><span class="token variable">$spam</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">fail</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'对不起，您的信息已经被列入黑名单，如有疑问请联系博主。'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre></div></div>

<p>至于其他的修改方法我也不知道怎么弄了，这只是给大家一个参考。</p>
<p>另外给大家推荐一个插件：<a target="_blank" rel="noopener" href="http://www.jiucool.com/spam_to_blacklist/">《WordPress插件：Spam_To_Blacklist》</a>，其作用就是把评论列为垃圾的时候，会把相关信息自动添加到黑名单中。</p>
</div></article><div class="end flex fai-c fjc-c mb-4"><span class="flex fai-c fjc-c my-4 o2">THE-END</span></div><div class="tags my-4"><ul class="flex fjc-c fd-r gap-4"><li><a class="py-1 px-4 flex fd-c fai-c" href="/tags/spam/"><span>spam<sup>2</sup></span></a></li><li><a class="py-1 px-4 flex fd-c fai-c" href="/tags/%E7%A6%81%E6%AD%A2/"><span>禁止<sup>2</sup></span></a></li><li><a class="py-1 px-4 flex fd-c fai-c" href="/tags/%E9%BB%91%E5%90%8D%E5%8D%95/"><span>黑名单<sup>1</sup></span></a></li></ul></div><div class="near flex fjc-sb mb-4"><div class="prev"><a href="/post/956ea6ac603858a5315db00d230089bd/" ref="prev"><div class="text fw-b">PREVIOUS</div><div class="name">动态 +1 效果</div></a></div><div class="next"><a href="/post/4aaa41ac4e4a8b4387b2eda3c06fe9ec/" ref="next"><div class="text">NEXT</div><div class="name">好好复习准备南下</div></a></div></div><div class="comments"><div class="comment-items"><h2 class="pl-2">评论列表</h2><div class="not-found flex fai-c fjc-c">「此时无声胜有声」</div></div></div></main><footer class="flex fjc-c"><div class="copyright"><p>© 2007 - 现在 <a href="">嘀咕</a></p></div></footer><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script><script type="text/javascript" src="/js/forever.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery-lazyload@1.9.7/jquery.lazyload.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script></div></body></html>